(()=>{"use strict";const t={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__save",inactiveButtonClass:"popup__save_disabled",activeButtonClass:"popup__save_valid",inputErrorClass:"popup__input_type_error",errorClass:"error"},e=document.querySelector(".profile__edit-avatar"),s=document.querySelector(".profile__add-button"),i=document.querySelector(".profile__edit-button"),n=document.querySelector(".profile__title"),a=document.querySelector(".profile__subtitle"),o=document.querySelector(".profile__avatar"),r=document.forms.editForm,l=document.forms.addForm,c=document.forms.editAvatarForm;class h{constructor(t,e,s,i,n,a,o){this._templateSelector=e,this._handleCardClick=s,this._userId=i,this._like=n,this._dislike=a,this._deleteCard=o,this._likes=t.likes,this._id=t._id,this._name=t.name,this._link=t.link,this._ownerId=t.owner._id}like(){this._likeButton.classList.add("element__like-button_active")}dislike(){this._likeButton.classList.remove("element__like-button_active")}_userLiked(){this._likes.forEach((t=>{t._id===this._userId?this.like():this.dislike()}))}likesCount(t){this._likesCount.textContent=`${t.likes.length}`}remove(){this._cardElement.remove()}generateCard=()=>{const t=document.querySelector(this._templateSelector);if(t){const e=t.content.querySelector(".element");e?this._cardElement=e.cloneNode(!0):console.log("В классе Card не найден .element!")}else console.log("В классе Card не найден "+this._templateSelector+"!");return this._likeButton=this._cardElement.querySelector(".element__like-button"),this._likesCount=this._cardElement.querySelector(".element__count-like"),this._likesCount.textContent=this._likes.length,this._deleteButtonTrash=this._cardElement.querySelector(".element__trash"),this._ownerId!==this._userId&&this._deleteButtonTrash.remove(),this._imageElementMask=this._cardElement.querySelector(".element__mask"),this._imageElementMask.src=this._link,this._imageElementMask.alt=this._name,this._cardElement.querySelector(".element__title").textContent=this._name,this._setEventListeners(),this._userLiked(),this._cardElement};_setEventListeners(){this._likeButton.addEventListener("click",(()=>{this._likeButton.classList.contains("element__like-button_active")?this._dislike():this._like()})),this._deleteButtonTrash.addEventListener("click",(()=>{this._deleteCard(this._id)})),this._imageElementMask.addEventListener("click",(()=>{this._handleCardClick(this._name,this._link)}))}}class _{constructor(t,e){this._form=e,this._config=t,this._buttonSave=this._form.querySelector(this._config.submitButtonSelector),this._inputList=Array.from(this._form.querySelectorAll(this._config.inputSelector))}enableValidation(){this._setEventListeners()}disableSubmitButton(){this._buttonSave.classList.remove(this._config.activeButtonClass),this._buttonSave.classList.add(this._config.inactiveButtonClass),this._buttonSave.disabled=!0}enableSubmitButton(){this._buttonSave.classList.add(this._config.activeButtonClass),this._buttonSave.classList.remove(this._config.inactiveButtonClass),this._buttonSave.disabled=!1}_showInputError(t){const e=this._form.querySelector(`.${t.id}-error`);e.classList.add(this._config.errorClass),e.textContent=t.validationMessage,t.classList.add(this._config.inputErrorClass)}_hideInputError(t){const e=this._form.querySelector(`.${t.id}-error`);e.classList.remove(this._config.errorClass),e.textContent="",t.classList.remove(this._config.inputErrorClass)}_checkInputValidity(t){t.validity.valid?this._hideInputError(t):this._showInputError(t)}_hasInvalidInput(){return this._inputList.some((t=>!t.validity.valid))}_toggleButtonState(){this._hasInvalidInput()?this.disableSubmitButton():this.enableSubmitButton()}_setEventListeners(){this._toggleButtonState(this._inputList,this._buttonSave),this._inputList.forEach((t=>{t.addEventListener("input",(()=>{this._checkInputValidity(t),this._toggleButtonState(this._inputList,this._buttonSave)}))}))}}class u{constructor(t){this._popup=document.querySelector(t),this._button=this._popup.querySelector(".popup__close"),this._clickCloseButton=this._handleSubmit.bind(this),this._clickEscClose=this._handleEscClose.bind(this),this._clickClose=this._handleClose.bind(this),this._button.addEventListener("click",this._clickCloseButton)}open(){this.setEventListeners(),this._popup.classList.add("popup_opened")}close(){this._popup.classList.remove("popup_opened"),this.delEventListeners()}_handleSubmit(){this.close()}_handleEscClose(t){"Escape"===t.key&&this.close()}_handleClose(t){t.target.classList.contains("popup_opened")&&this.close()}setEventListeners(){document.addEventListener("keydown",this._clickEscClose),document.addEventListener("mouseup",this._clickClose)}delEventListeners(){document.removeEventListener("keydown",this._clickEscClose),document.removeEventListener("mouseup",this._clickClose)}}class d extends u{constructor(t,e){super(t),this._callbackSubmit=e,this._form=this._popup.querySelector(".popup__form"),this._inputs=[...this._form.querySelectorAll(".popup__input")],this._form.addEventListener("submit",(t=>{t.preventDefault();const e=t.submitter.textContent;t.submitter.textContent="Сохранение...",this._callbackSubmit(this._getInputValues()).then((()=>this.close())).finally((()=>{t.submitter.textContent=e}))}))}_getInputValues(){const t={};return this._inputs.forEach((e=>{t[e.name]=e.value})),t}setInputValue(t){this._inputs.forEach((e=>{e.value=t[e.name]}))}close(){super.close(),this._form.reset()}}let p;function m(t){const e=new h(t,".element-template",v,p,(async()=>{try{const s=await q.addLike(t._id);e.like(),e.likesCount(s)}catch(t){return console.log(`Ошибка: ${t}`)}}),(async()=>{try{const s=await q.removeLike(t._id);e.dislike(),e.likesCount(s)}catch(t){return console.log(`Ошибка: ${t}`)}}),(()=>{L.open(e)}));return e.generateCard()}function v(t,e){b.open(t,e)}const b=new class extends u{constructor(t){super(t),this._imagePopup=this._popup.querySelector(".popup__image"),this._imagePopupTitle=this._popup.querySelector(".popup__image-title")}open(t,e){this._imagePopupTitle.textContent=t,this._imagePopup.alt="Картинка "+t,this._imagePopup.src=e,super.open()}}(".popup_type_image"),f=new d(".popup_type_add-card",(async function(t){try{const e=await q.addNewCard(t);I.addItem(m(e))}catch(t){return console.log(`Ошибка: ${t}`)}})),k=new d(".popup_type_edit-profile",(async function(t){try{const e=await q.editProfileUserInfo(t);y.setUserInfo(e)}catch(t){return console.log(`Ошибка: ${t}`)}})),S=new d(".popup_type_update-avatar",(async function(t){try{const e=await q.updateProfileUserAvatar(t);y.setUserInfo(e)}catch(t){return console.log(`Ошибка: ${t}`)}})),y=new class{constructor({name:t,about:e,avatar:s}){this._data={name:t.textContent,about:e.textContent,avatar:s.textContent},this._name=t,this._about=e,this._avatar=s}getUserInfo(){return{name:this._data.name,about:this._data.about,avatar:this._data.avatar}}setUserInfo(t){this._data.name=t.name,this._data.about=t.about,this._data.avatar=t.avatar,t.name&&(this._name.textContent=this._data.name),t.about&&(this._about.textContent=this._data.about),t.avatar&&(this._avatar.src=this._data.avatar,this._avatar.alt=this._data.name)}}({name:n,about:a,avatar:o});i.addEventListener("click",(()=>{k.open(),k.setInputValue(y.getUserInfo()),g.disableSubmitButton()}),!1),e.addEventListener("click",(()=>{S.open(),E.disableSubmitButton()}),!1),s.addEventListener("click",(()=>{f.open(),C.disableSubmitButton()}),!1);const g=new _(t,r);g.enableValidation();const C=new _(t,l);C.enableValidation();const E=new _(t,c);E.enableValidation();const L=new class extends u{constructor(t,e){super(t),this._handleSubmit=e,this._popupForm=this._popup.querySelector(".popup__form"),this._popupForm.addEventListener("submit",(t=>{t.preventDefault(),this._handleSubmit(this._card)}))}open(t){this._card=t,super.open()}}(".popup_type_confirmation",(async t=>{q.removeCard(t._id).then((()=>{t.remove(),L.close()})).catch((t=>console.log(`Ошибка: ${t}`)))})),I=new class{constructor({renderer:t},e){this._renderer=t,this._container=document.querySelector(e)}addItem=t=>{this._container.prepend(t)};renderItems(t){t.reverse().forEach((t=>this._renderer(t)))}}({renderer:t=>{const e=m(t);I.addItem(e)}},".elements");console.log();const q=new class{constructor(t){this._baseUrl=t.baseUrl,this._headers=t.headers}_handleSendingRequest(t){return t.ok?Promise.resolve(t.json()):Promise.reject(`Ошибка: ${t.status}`)}async getRealUserInfo(){const t=await fetch(`${this._baseUrl}/users/me`,{headers:this._headers});return this._handleSendingRequest(t)}async getInitialCards(){const t=await fetch(`${this._baseUrl}/cards`,{headers:this._headers});return this._handleSendingRequest(t)}async editProfileUserInfo(t){const e=await fetch(`${this._baseUrl}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:t.name,about:t.about})});return this._handleSendingRequest(e)}async addNewCard(t){const e=await fetch(`${this._baseUrl}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify(t)});return this._handleSendingRequest(e)}async addLike(t){const e=await fetch(`${this._baseUrl}/cards/${t}/likes`,{method:"PUT",headers:this._headers});return this._handleSendingRequest(e)}async removeCard(t){const e=await fetch(`${this._baseUrl}/cards/${t}`,{method:"DELETE",headers:this._headers});return this._handleSendingRequest(e)}async removeLike(t){const e=await fetch(`${this._baseUrl}/cards/${t}/likes`,{method:"DELETE",headers:this._headers});return this._handleSendingRequest(e)}async updateProfileUserAvatar(t){const e=await fetch(`${this._baseUrl}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:t.avatar})});return this._handleSendingRequest(e)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-60",headers:{authorization:"ea996ec4-3586-49ec-99cf-46c56e637a89","Content-Type":"application/json"}});Promise.all([q.getRealUserInfo(),q.getInitialCards()]).then((([t,e])=>{y.setUserInfo(t),p=t._id,I.renderItems(e)})).catch((t=>console.log(`Ошибка: ${t}`)))})();