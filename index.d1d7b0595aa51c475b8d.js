(()=>{"use strict";const e={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__save",inactiveButtonClass:"popup__save_disabled",activeButtonClass:"popup__save_valid",inputErrorClass:"popup__input_type_error",errorClass:"error"},t=document.querySelector(".profile__edit-avatar"),s=document.querySelector(".profile__add-button"),i=document.querySelector(".profile__edit-button"),n=document.querySelector(".profile__title"),o=document.querySelector(".profile__subtitle"),r=document.querySelector(".profile__avatar"),a=document.forms.editForm,l=document.forms.addForm,c=document.forms.editAvatarForm;class h{constructor(e,t,s,i,n,o,r){this._templateSelector=t,this._handleCardClick=s,this._userId=i,this._like=n,this._dislike=o,this._deleteCard=r,this._likes=e.likes,this._id=e._id,this._name=e.name,this._link=e.link,this._ownerId=e.owner._id}like(){this._likeButton.classList.add("element__like-button_active")}dislike(){this._likeButton.classList.remove("element__like-button_active")}_userLiked(){this._likes.forEach((e=>{e._id===this._userId?this.like():this.dislike()}))}likesCount(e){this._likesCount.textContent=`${e.likes.length}`}remove(){this._cardElement.remove()}generateCard=()=>{const e=document.querySelector(this._templateSelector);if(e){const t=e.content.querySelector(".element");t?this._cardElement=t.cloneNode(!0):console.log("В классе Card не найден .element!")}else console.log("В классе Card не найден "+this._templateSelector+"!");return this._likeButton=this._cardElement.querySelector(".element__like-button"),this._likesCount=this._cardElement.querySelector(".element__count-like"),this._likesCount.textContent=this._likes.length,this._deleteButtonTrash=this._cardElement.querySelector(".element__trash"),this._ownerId!==this._userId&&this._deleteButtonTrash.remove(),this._imageElementMask=this._cardElement.querySelector(".element__mask"),this._imageElementMask.src=this._link,this._imageElementMask.alt=this._name,this._cardElement.querySelector(".element__title").textContent=this._name,this._setEventListeners(),this._userLiked(),this._cardElement};_setEventListeners(){this._likeButton.addEventListener("click",(()=>{this._likeButton.classList.contains("element__like-button_active")?this._dislike():this._like()})),this._deleteButtonTrash.addEventListener("click",(()=>{this._deleteCard(this._id)})),this._imageElementMask.addEventListener("click",(()=>{this._handleCardClick(this._name,this._link)}))}}class u{constructor(e,t){this._form=t,this._config=e,this._buttonSave=this._form.querySelector(this._config.submitButtonSelector),this._inputList=Array.from(this._form.querySelectorAll(this._config.inputSelector))}enableValidation(){this._setEventListeners()}disableSubmitButton(){this._buttonSave.classList.remove(this._config.activeButtonClass),this._buttonSave.classList.add(this._config.inactiveButtonClass),this._buttonSave.disabled=!0}enableSubmitButton(){this._buttonSave.classList.add(this._config.activeButtonClass),this._buttonSave.classList.remove(this._config.inactiveButtonClass),this._buttonSave.disabled=!1}_showInputError(e){const t=this._form.querySelector(`.${e.id}-error`);t.classList.add(this._config.errorClass),t.textContent=e.validationMessage,e.classList.add(this._config.inputErrorClass)}_hideInputError(e){const t=this._form.querySelector(`.${e.id}-error`);t.classList.remove(this._config.errorClass),t.textContent="",e.classList.remove(this._config.inputErrorClass)}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e)}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}_toggleButtonState(){this._hasInvalidInput()?this.disableSubmitButton():this.enableSubmitButton()}_setEventListeners(){this._toggleButtonState(this._inputList,this._buttonSave),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState(this._inputList,this._buttonSave)}))}))}}class _{constructor(e){this._popup=document.querySelector(e),this._button=this._popup.querySelector(".popup__close"),this._clickCloseButton=this._handleSubmit.bind(this),this._clickEscClose=this._handleEscClose.bind(this),this._clickClose=this._handleClose.bind(this),this._button.addEventListener("click",this._clickCloseButton)}open(){this.setEventListeners(),this._popup.classList.add("popup_opened")}close(){this._popup.classList.remove("popup_opened"),this.delEventListeners()}_handleSubmit(){this.close()}_handleEscClose(e){"Escape"===e.key&&this.close()}_handleClose(e){e.target.classList.contains("popup_opened")&&this.close()}setEventListeners(){console.log("setEventListeners from Popup"),document.addEventListener("keydown",this._clickEscClose),document.addEventListener("mouseup",this._clickClose)}delEventListeners(){document.removeEventListener("keydown",this._clickEscClose),document.removeEventListener("mouseup",this._clickClose)}}class d extends _{constructor(e,t){super(e),this._callbackSubmit=t,this._form=this._popup.querySelector(".popup__form"),this._inputs=[...this._form.querySelectorAll(".popup__input")],this._form.addEventListener("submit",(e=>{e.preventDefault();const t=e.submitter.textContent;e.submitter.textContent="Сохранение...",this._callbackSubmit(this._getInputValues()).then((()=>this.close())).finally((()=>{e.submitter.textContent=t}))}))}_getInputValues(){const e={};return this._inputs.forEach((t=>{e[t.name]=t.value})),e}setInputValue(e){this._inputs.forEach((t=>{t.value=e[t.name]}))}close(){super.close(),this._form.reset()}}let p;function m(e){const t=new h(e,".element-template",v,p,(async()=>{try{const s=await q.addLike(e._id);t.like(),t.likesCount(s)}catch(e){return console.log(`Ошибка: ${e}`)}}),(async()=>{try{const s=await q.removeLike(e._id);t.dislike(),t.likesCount(s)}catch(e){return console.log(`Ошибка: ${e}`)}}),(()=>{L.open(t)}));return t.generateCard()}function v(e,t){b.open(e,t)}const b=new class extends _{constructor(e){super(e),this._imagePopup=this._popup.querySelector(".popup__image"),this._imagePopupTitle=this._popup.querySelector(".popup__image-title")}open(e,t){this._imagePopupTitle.textContent=e,this._imagePopup.alt="Картинка "+e,this._imagePopup.src=t,super.open()}}(".popup_type_image"),f=new d(".popup_type_add-card",(async function(e){try{const t=await q.addNewCard(e);I.addItem(m(t)),f.close()}catch(e){return console.log(`Ошибка: ${e}`)}})),k=new d(".popup_type_edit-profile",(async function(e){try{const t=await q.editProfileUserInfo(e);g.setUserInfo(t),k.close()}catch(e){return console.log(`Ошибка: ${e}`)}})),S=new d(".popup_type_update-avatar",(async function(e){try{const t=await q.updateProfileUserAvatar(e);g.setUserInfo(t),r.src=t.avatar,S.close()}catch(e){return console.log(`Ошибка: ${e}`)}})),g=new class{constructor({name:e,about:t,avatar:s}){this._name=e,this._about=t,this._avatar=s}getUserInfo(){return{name:this._name.textContent,about:this._about.textContent,avatar:this._avatar.textContent}}setUserInfo(e){e.name&&(this._name.textContent=e.name),e.about&&(this._about.textContent=e.about),e.avatar&&(this._avatar.textContent=e.avatar)}}({name:n,about:o,avatar:r});i.addEventListener("click",(()=>{k.open(),k.setInputValue(g.getUserInfo()),y.disableSubmitButton()}),!1),t.addEventListener("click",(()=>{S.open(),S.setInputValue(g.getUserInfo()),E.disableSubmitButton()}),!1),s.addEventListener("click",(()=>{f.open(),C.disableSubmitButton()}),!1);const y=new u(e,a);y.enableValidation();const C=new u(e,l);C.enableValidation();const E=new u(e,c);E.enableValidation();const L=new class extends _{constructor(e,t){super(e),this._handleSubmit=t,this._popupForm=this._popup.querySelector(".popup__form")}open(e){this._card=e,super.open()}setEventListeners(){super.setEventListeners(),this._popupForm.addEventListener("submit",(e=>{e.preventDefault(),this._handleSubmit(this._card)}))}}(".popup_type_confirmation",(async e=>{q.removeCard(e._id).then((()=>{e.remove(),L.close()})).catch((e=>console.log(`Ошибка: ${e}`)))})),I=new class{constructor({renderer:e},t){this._renderer=e,this._container=document.querySelector(t)}addItem=e=>{this._container.prepend(e)};renderItems(e){e.forEach((e=>this._renderer(e)))}}({renderer:e=>{const t=m(e);I.addItem(t)}},".elements");console.log();const q=new class{constructor(e){this._baseUrl=e.baseUrl,this._headers=e.headers}_handleSendingRequest(e){return e.ok?Promise.resolve(e.json()):Promise.reject(`Ошибка: ${e.status}`)}async getRealUserInfo(){const e=await fetch(`${this._baseUrl}/users/me`,{headers:this._headers});return this._handleSendingRequest(e)}async getInitialCards(){const e=await fetch(`${this._baseUrl}/cards`,{headers:this._headers});return this._handleSendingRequest(e)}async editProfileUserInfo(e){const t=await fetch(`${this._baseUrl}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e.name,about:e.about})});return this._handleSendingRequest(t)}async addNewCard(e){const t=await fetch(`${this._baseUrl}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify(e)});return this._handleSendingRequest(t)}async addLike(e){const t=await fetch(`${this._baseUrl}/cards/${e}/likes`,{method:"PUT",headers:this._headers});return this._handleSendingRequest(t)}async removeCard(e){const t=await fetch(`${this._baseUrl}/cards/${e}`,{method:"DELETE",headers:this._headers});return this._handleSendingRequest(t)}async removeLike(e){const t=await fetch(`${this._baseUrl}/cards/${e}/likes`,{method:"DELETE",headers:this._headers});return this._handleSendingRequest(t)}async updateProfileUserAvatar(e){const t=await fetch(`${this._baseUrl}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e.avatar})});return this._handleSendingRequest(t)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-60",headers:{authorization:"78d656f5-7266-4e0f-8f5e-4b00861a3a36","Content-Type":"application/json"}});Promise.all([q.getRealUserInfo(),q.getInitialCards()]).then((([e,t])=>{g.setUserInfo(e),p=e._id,r.src=e.avatar,I.renderItems(t)})).catch((e=>console.log(`Ошибка: ${e}`)))})();